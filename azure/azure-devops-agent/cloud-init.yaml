#cloud-config

# Azure DevOps Agent Cloud-Init Configuration
# This script sets up a self-hosted Azure Pipelines agent with Docker-in-Docker support

package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq
  - wget
  - git
  - unzip

write_files:
  # Azure DevOps Agent start script
  - path: /usr/local/bin/start_azdevops_agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      echo "Starting Azure DevOps Agent..."
      
      # Environment variables (passed from Terraform)
      AZP_URL="${azp_url}"
      AZP_TOKEN="${azp_token}"
      AZP_POOL="${azp_pool}"
      AZP_AGENT_NAME_PREFIX="${azp_agent_name}"
      AGENT_COUNT="${agent_count}"
      
      # Production Features Configuration
      ENABLE_CACHE="${enable_distributed_cache}"
      CACHE_STORAGE_ACCOUNT="${cache_storage_account_name}"
      CACHE_CONTAINER="${cache_storage_container_name}"
      CACHE_STORAGE_KEY="${cache_storage_account_key}"
      CACHE_SHARED="${cache_shared}"
      ENABLE_LOGGING="${enable_centralized_logging}"
      LOG_ANALYTICS_WORKSPACE_ID="${log_analytics_workspace_id}"
      LOG_ANALYTICS_WORKSPACE_KEY="${log_analytics_workspace_key}"
      ENABLE_MONITORING="${enable_agent_monitoring}"
      METRICS_PORT="${metrics_port}"
      
      # Auto-detect agent count based on CPU count if agent_count is 0
      if [ "$AGENT_COUNT" = "0" ]; then
        CPU_COUNT=$(nproc)
        # Scale agent count based on available CPUs:
        # 1-2 CPUs: 1 agent, 3-4 CPUs: 2 agents, 5-8 CPUs: 3 agents
        # 9-16 CPUs: 4 agents, 17+ CPUs: CPU_COUNT / 4 (rounded up)
        if [ $CPU_COUNT -le 2 ]; then
          AGENT_COUNT=1
        elif [ $CPU_COUNT -le 4 ]; then
          AGENT_COUNT=2
        elif [ $CPU_COUNT -le 8 ]; then
          AGENT_COUNT=3
        elif [ $CPU_COUNT -le 16 ]; then
          AGENT_COUNT=4
        else
          AGENT_COUNT=$(( (CPU_COUNT + 3) / 4 ))
        fi
        echo "Auto-detected $CPU_COUNT CPUs, will run $AGENT_COUNT agents"
      fi
      
      # Calculate CPU limit per agent
      CPU_COUNT=$(nproc)
      MAX_CPU=$((CPU_COUNT / AGENT_COUNT))
      [ $MAX_CPU -lt 1 ] && MAX_CPU=1
      
      # Configure distributed cache if enabled
      CACHE_ENV_VARS=""
      if [ "$ENABLE_CACHE" = "true" ]; then
        echo "Configuring distributed cache (Azure Blob Storage)..."
        CACHE_ENV_VARS="-e CACHE_ENABLED=true \
          -e CACHE_TYPE=azure \
          -e AZURE_STORAGE_ACCOUNT=$CACHE_STORAGE_ACCOUNT \
          -e AZURE_STORAGE_KEY=$CACHE_STORAGE_KEY \
          -e AZURE_STORAGE_CONTAINER=$CACHE_CONTAINER \
          -e CACHE_SHARED=$CACHE_SHARED"
        echo "  Cache storage account: $CACHE_STORAGE_ACCOUNT"
        echo "  Cache container: $CACHE_CONTAINER"
        echo "  Shared cache: $CACHE_SHARED"
      fi
      
      # Configure monitoring if enabled
      MONITORING_ENV_VARS=""
      MONITORING_PORT=""
      if [ "$ENABLE_MONITORING" = "true" ]; then
        echo "Enabling agent monitoring (Prometheus metrics)..."
        MONITORING_ENV_VARS="-e METRICS_ENABLED=true -e METRICS_PORT=$METRICS_PORT"
        MONITORING_PORT="-p $METRICS_PORT:$METRICS_PORT"
        echo "  Metrics port: $METRICS_PORT"
      fi
      
      # Validate required variables
      if [ -z "$AZP_URL" ] || [ -z "$AZP_TOKEN" ] || [ -z "$AZP_POOL" ]; then
        echo "ERROR: Missing required environment variables"
        echo "AZP_URL=$AZP_URL"
        echo "AZP_TOKEN=***"
        echo "AZP_POOL=$AZP_POOL"
        exit 1
      fi
      
      echo "Starting $AGENT_COUNT Azure DevOps agent(s)..."
      
      # Start multiple agent containers
      for A in $(seq 1 $AGENT_COUNT); do
        AZP_AGENT_NAME="$AZP_AGENT_NAME_PREFIX-$(hostname)-$A"
        WORK_DIR="/azp/agent$A/_work"
        CONTAINER_NAME="azdevops-agent-$A"
        
        mkdir -p "$WORK_DIR"
        
        echo "Starting agent $A/$AGENT_COUNT: $AZP_AGENT_NAME"
        
        if docker ps -a --format '{{.Names}}' | grep -q "^$CONTAINER_NAME$"; then
          echo "  Removing existing container: $CONTAINER_NAME"
          docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true
        fi
        
        docker run -d \
          --name "$CONTAINER_NAME" \
          --restart unless-stopped \
          --cpus="$MAX_CPU" \
          -e AZP_URL="$AZP_URL" \
          -e AZP_TOKEN="$AZP_TOKEN" \
          -e AZP_POOL="$AZP_POOL" \
          -e AZP_AGENT_NAME="$AZP_AGENT_NAME" \
          -e AZP_WORK="/_work" \
          $CACHE_ENV_VARS \
          $MONITORING_ENV_VARS \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v "$WORK_DIR":/_work \
          $MONITORING_PORT \
          --privileged \
          fok666/azuredevops:latest
        
        echo "  Container $CONTAINER_NAME started successfully"
      done
      
      echo "All agents started successfully!"
      
      # Install Azure Monitor Agent (OMS) if centralized logging is enabled
      if [ "$ENABLE_LOGGING" = "true" ]; then
        echo "Installing Azure Monitor Agent for centralized logging..."
        if [ ! -z "$LOG_ANALYTICS_WORKSPACE_ID" ] && [ ! -z "$LOG_ANALYTICS_WORKSPACE_KEY" ]; then
          wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh
          sh onboard_agent.sh -w "$LOG_ANALYTICS_WORKSPACE_ID" -s "$LOG_ANALYTICS_WORKSPACE_KEY" -d opinsights.azure.com
          
          # Configure syslog and Docker logs collection
          sudo /opt/microsoft/omsagent/bin/service_control restart "$LOG_ANALYTICS_WORKSPACE_ID"
          echo "Azure Monitor Agent installed and configured"
        else
          echo "WARNING: Centralized logging enabled but workspace credentials not provided"
        fi
      fi

  # Agent stop script (for graceful shutdown)
  - path: /usr/local/bin/stop_azdevops_agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "Stopping Azure DevOps Agent gracefully..."
      
      # Get all agent containers
      CONTAINERS=$(docker ps --filter "name=azdevops-agent" --format "{{.ID}}")
      
      if [ -z "$CONTAINERS" ]; then
        echo "No agent containers running"
        exit 0
      fi
      
      # Stop each container gracefully
      for CONTAINER in $CONTAINERS; do
        echo "Stopping container: $CONTAINER"
        docker stop -t 60 "$CONTAINER" || true
        docker rm "$CONTAINER" || true
      done
      
      echo "All agents stopped"

  # VMSS Scheduled Events monitor (spot termination detection)
  - path: /usr/local/bin/vmss_monitor.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Monitor Azure VMSS Scheduled Events for spot instance termination
      
      METADATA_ENDPOINT="http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01"
      LOG_FILE="/var/log/vmss_monitor.log"
      
      while true; do
        # Query scheduled events
        EVENTS=$(curl -s -H "Metadata:true" "$METADATA_ENDPOINT" 2>/dev/null)
        
        if [ $? -eq 0 ] && [ ! -z "$EVENTS" ]; then
          # Check for Preempt or Terminate events
          EVENT_COUNT=$(echo "$EVENTS" | jq -r '.Events | length' 2>/dev/null || echo "0")
          
          if [ "$EVENT_COUNT" -gt 0 ]; then
            echo "[$(date)] Scheduled event detected!" | tee -a "$LOG_FILE"
            echo "$EVENTS" | jq '.' | tee -a "$LOG_FILE"
            
            # Stop agents gracefully
            /usr/local/bin/stop_azdevops_agent.sh 2>&1 | tee -a "$LOG_FILE"
            
            # Acknowledge the event
            EVENT_ID=$(echo "$EVENTS" | jq -r '.Events[0].EventId')
            if [ ! -z "$EVENT_ID" ]; then
              curl -X POST -H "Metadata:true" \
                -d "{\"StartRequests\": [{\"EventId\": \"$EVENT_ID\"}]}" \
                "$METADATA_ENDPOINT" 2>&1 | tee -a "$LOG_FILE"
            fi
            
            echo "[$(date)] Graceful shutdown complete" | tee -a "$LOG_FILE"
            break
          fi
        fi
        
        # Check every 15 seconds
        sleep 15
      done

  # Systemd service for agent
  - path: /etc/systemd/system/azdevops-agent.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Azure DevOps Agent
      After=docker.service
      Requires=docker.service
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/start_azdevops_agent.sh
      ExecStop=/usr/local/bin/stop_azdevops_agent.sh
      
      [Install]
      WantedBy=multi-user.target

  # Systemd service for VMSS monitor
  - path: /etc/systemd/system/vmss-monitor.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Azure VMSS Scheduled Events Monitor
      After=network.target
      
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/vmss_monitor.sh
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

  # Cron job for periodic monitoring (backup)
  - path: /etc/cron.d/vmss-monitor
    permissions: '0644'
    content: |
      */1 * * * * root /usr/local/bin/vmss_monitor.sh >> /var/log/vmss_monitor.log 2>&1

runcmd:
  # Add user to docker group
  - usermod -aG docker azureuser
  
  # Create work directory
  - mkdir -p /azp/_work
  - chown -R azureuser:azureuser /azp
  
  # Enable and start services
  - systemctl daemon-reload
  - systemctl enable docker
  - systemctl start docker
  
  # Wait for Docker to be ready
  - timeout 60 bash -c 'until docker info; do sleep 2; done'
  
  # Start Azure DevOps agent
  - systemctl enable azdevops-agent.service
  - systemctl start azdevops-agent.service
  
  # Start VMSS monitor
  - systemctl enable vmss-monitor.service
  - systemctl start vmss-monitor.service
  
  # Log initialization complete
  - echo "Azure DevOps Agent initialization complete at $(date)" > /var/log/agent-init-complete.log

final_message: "Azure DevOps Agent is ready!"
