name: Pre-commit Checks

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  pre-commit:
    name: Run Pre-commit Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Check for existing pre-commit config
        id: check-config
        run: |
          if [ -f ".pre-commit-config.yaml" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "ℹ️  Using existing .pre-commit-config.yaml"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "ℹ️  Will create temporary .pre-commit-config.yaml"
          fi

      - name: Create temporary pre-commit config
        if: steps.check-config.outputs.config_exists == 'false'
        run: |
          cat > .pre-commit-config.yaml << 'EOF'
          repos:
            - repo: https://github.com/pre-commit/pre-commit-hooks
              rev: v4.5.0
              hooks:
                - id: trailing-whitespace
                - id: end-of-file-fixer
                - id: check-yaml
                  args: [--allow-multiple-documents]
                - id: check-added-large-files
                  args: ['--maxkb=1000']
                - id: check-merge-conflict
                - id: detect-private-key
            
            - repo: https://github.com/antonbabenko/pre-commit-terraform
              rev: v1.86.0
              hooks:
                - id: terraform_fmt
                - id: terraform_validate
                - id: terraform_docs
                  args:
                    - --hook-config=--path-to-file=README.md
                    - --hook-config=--add-to-existing-file=true
                    - --hook-config=--create-file-if-not-exist=true
          EOF

      - name: Run pre-commit on all files
        run: pre-commit run --all-files --show-diff-on-failure || true

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_names: 'cloud-init.yaml'
