name: Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation files
        run: |
          echo "Checking for required documentation files..."
          
          required_files="README.md QUICKSTART.md TESTING_GUIDE.md SECURITY.md ARCHITECTURE.md"
          missing_files=""
          
          for file in $required_files; do
            if [ ! -f "$file" ]; then
              missing_files="$missing_files $file"
            fi
          done
          
          if [ -n "$missing_files" ]; then
            echo "âŒ Missing required documentation files:"
            echo "$missing_files"
            exit 1
          fi
          
          echo "âœ… All required documentation files are present"

      - name: Check if markdown link config exists
        id: check-config
        run: |
          if [ -f ".github/markdown-link-check-config.json" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: ${{ steps.check-config.outputs.config_exists == 'true' && '.github/markdown-link-check-config.json' || '' }}
        continue-on-error: true

      - name: Validate Mermaid diagrams
        run: |
          echo "Checking for Mermaid diagram syntax..."
          
          # Check if any .md files contain mermaid blocks
          if grep -r "```mermaid" . --include="*.md" > /dev/null; then
            echo "âœ… Found Mermaid diagrams"
            
            # Basic syntax check - look for common issues
            errors=0
            
            # Check for unclosed mermaid blocks
            for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*"); do
              mermaid_opens=$(grep -c '```mermaid' "$file" || true)
              code_closes=$(grep -c '```$' "$file" || true)
              
              if [ $mermaid_opens -gt 0 ]; then
                echo "  Checking $file: $mermaid_opens Mermaid diagram(s)"
              fi
            done
            
            echo "âœ… Mermaid diagram syntax looks good"
          else
            echo "â„¹ï¸  No Mermaid diagrams found"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation validation completed" >> $GITHUB_STEP_SUMMARY

  documentation-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [documentation-check]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“š Documentation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Check | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.documentation-check.result }}" == "success" ]; then
            echo "âœ… All documentation checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Documentation checks failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Releases are managed by the Terraform Validation workflow" >> $GITHUB_STEP_SUMMARY
