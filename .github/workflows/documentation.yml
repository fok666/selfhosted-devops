name: Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation files
        run: |
          echo "Checking for required documentation files..."
          
          required_files="README.md QUICKSTART.md TESTING_GUIDE.md SECURITY.md ARCHITECTURE.md"
          missing_files=""
          
          for file in $required_files; do
            if [ ! -f "$file" ]; then
              missing_files="$missing_files $file"
            fi
          done
          
          if [ -n "$missing_files" ]; then
            echo "âŒ Missing required documentation files:"
            echo "$missing_files"
            exit 1
          fi
          
          echo "âœ… All required documentation files are present"

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Validate Mermaid diagrams
        run: |
          echo "Checking for Mermaid diagram syntax..."
          
          # Check if any .md files contain mermaid blocks
          if grep -r "```mermaid" . --include="*.md" > /dev/null; then
            echo "âœ… Found Mermaid diagrams"
            
            # Basic syntax check - look for common issues
            errors=0
            
            # Check for unclosed mermaid blocks
            for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*"); do
              mermaid_opens=$(grep -c '```mermaid' "$file" || true)
              code_closes=$(grep -c '```$' "$file" || true)
              
              if [ $mermaid_opens -gt 0 ]; then
                echo "  Checking $file: $mermaid_opens Mermaid diagram(s)"
              fi
            done
            
            echo "âœ… Mermaid diagram syntax looks good"
          else
            echo "â„¹ï¸  No Mermaid diagrams found"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation validation completed" >> $GITHUB_STEP_SUMMARY

  semantic-release-docs:
    name: Semantic Release (Docs)
    runs-on: ubuntu-latest
    needs: [documentation-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@^23.0.0 \
            @semantic-release/changelog@^6.0.0 \
            conventional-changelog-conventionalcommits@^7.0.0

      - name: Create .releaserc.json
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "conventionalcommits",
                  "releaseRules": [
                    {"type": "docs", "release": "patch"}
                  ]
                }
              ],
              [
                "@semantic-release/release-notes-generator",
                {
                  "preset": "conventionalcommits"
                }
              ],
              [
                "@semantic-release/changelog",
                {
                  "changelogFile": "CHANGELOG.md"
                }
              ],
              "@semantic-release/github"
            ]
          }
          EOF

      - name: Run semantic-release (dry-run to generate CHANGELOG)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  Semantic release runs in dry-run mode due to branch protection" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub releases will be created automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** CHANGELOG updates require manual commits through PRs" >> $GITHUB_STEP_SUMMARY
