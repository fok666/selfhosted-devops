name: Terraform Validation

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: write  # Changed from read to write for tagging
  security-events: write
  pull-requests: write

jobs:
  terraform-validation:
    name: Validate Terraform Configurations
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        terraform-dir:
          - aws/azure-devops-agent
          - aws/github-runner
          - aws/gitlab-runner
          - azure/azure-devops-agent
          - azure/github-runner
          - azure/gitlab-runner
          - modules/aws-asg
          - modules/azure-vmss
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.9.0

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        working-directory: ${{ matrix.terraform-dir }}
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        working-directory: ${{ matrix.terraform-dir }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ matrix.terraform-dir }}

      - name: Comment PR (if applicable)
        if: github.event_name == 'pull_request' && (steps.fmt.outcome == 'failure' || steps.validate.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Validation Results for \`${{ matrix.terraform-dir }}\`
            
            #### Format Check üñå \`${{ steps.fmt.outcome }}\`
            #### Initialization ‚öôÔ∏è \`${{ steps.init.outcome }}\`
            #### Validation ü§ñ \`${{ steps.validate.outcome }}\`
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-test:
    name: Run Terraform Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # Module tests
          - test-dir: modules/aws-asg
            name: AWS ASG Module
          - test-dir: modules/azure-vmss
            name: Azure VMSS Module
          # Integration tests
          - test-dir: aws/gitlab-runner
            name: AWS GitLab Runner
          - test-dir: azure/gitlab-runner
            name: Azure GitLab Runner
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.9.0

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.test-dir }}

      - name: Run Terraform Tests
        id: test
        run: |
          echo "Running tests for ${{ matrix.name }}..."
          if [ -d "tests" ]; then
            terraform test -verbose
            echo "test_status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  No tests found in ${{ matrix.test-dir }}/tests"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
          fi
        working-directory: ${{ matrix.test-dir }}
        continue-on-error: false

      - name: Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Test Results for \`${{ matrix.name }}\`
            
            **Status:** ${{ steps.test.outputs.test_status == 'passed' && '‚úÖ Passed' || '‚ö†Ô∏è Skipped' }}
            
            <details>
            <summary>Test Details</summary>
            
            Tests validate:
            - Variable validation and constraints
            - Security defaults (IMDSv2, no SSH, encryption)
            - Cost optimization (spot instances, scale-to-zero)
            - Autoscaling configuration
            - Network isolation
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-lint:
    name: Lint Terraform with tflint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        terraform-dir:
          - aws/azure-devops-agent
          - aws/github-runner
          - aws/gitlab-runner
          - azure/azure-devops-agent
          - azure/github-runner
          - azure/gitlab-runner
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init
        working-directory: ${{ matrix.terraform-dir }}

      - name: Run TFLint
        run: tflint --format compact
        working-directory: ${{ matrix.terraform-dir }}
        continue-on-error: true

  security-scan:
    name: Security Scan with Trivy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy for Terraform
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation files
        run: |
          echo "Checking for required documentation files..."
          
          required_files="README.md QUICKSTART.md TESTING_GUIDE.md"
          missing_files=""
          
          for file in $required_files; do
            if [ ! -f "$file" ]; then
              missing_files="$missing_files $file"
            fi
          done
          
          if [ -n "$missing_files" ]; then
            echo "‚ùå Missing required documentation files:"
            echo "$missing_files"
            exit 1
          fi
          
          echo "‚úÖ All required documentation files are present"

      - name: Check for README in subdirectories
        run: |
          echo "Checking for README files in main directories..."
          
          dirs="aws azure modules"
          warnings=0
          
          for dir in $dirs; do
            if [ -d "$dir" ]; then
              subdirs=$(find "$dir" -mindepth 1 -maxdepth 1 -type d)
              for subdir in $subdirs; do
                if [ ! -f "$subdir/README.md" ]; then
                  echo "‚ö†Ô∏è  Missing README.md in $subdir"
                  warnings=$((warnings + 1))
                fi
              done
            fi
          done
          
          if [ $warnings -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $warnings directories without README files"
          else
            echo "‚úÖ All subdirectories have README files"
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-validation, terraform-test, terraform-lint, security-scan, documentation-check]
    if: always()
    
    steps:
      - name: Check validation results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validation | ${{ needs.terraform-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Tests | ${{ needs.terraform-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Lint | ${{ needs.terraform-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Check | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.terraform-validation.result }}" != "success" ] || [ "${{ needs.terraform-test.result }}" != "success" ]; then
            echo "‚ùå Terraform validation or tests failed"
            exit 1
          fi

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [summary]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for semantic versioning
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@^23.0.0 \
            @semantic-release/git@^10.0.0 \
            @semantic-release/changelog@^6.0.0 \
            @semantic-release/exec@^6.0.0 \
            conventional-changelog-conventionalcommits@^7.0.0

      - name: Create .releaserc.json
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "conventionalcommits",
                  "releaseRules": [
                    {"type": "feat", "release": "minor"},
                    {"type": "fix", "release": "patch"},
                    {"type": "perf", "release": "patch"},
                    {"type": "revert", "release": "patch"},
                    {"type": "docs", "release": "patch"},
                    {"type": "style", "release": false},
                    {"type": "refactor", "release": "patch"},
                    {"type": "test", "release": false},
                    {"type": "build", "release": false},
                    {"type": "ci", "release": false},
                    {"type": "chore", "release": false},
                    {"breaking": true, "release": "major"}
                  ]
                }
              ],
              [
                "@semantic-release/release-notes-generator",
                {
                  "preset": "conventionalcommits",
                  "presetConfig": {
                    "types": [
                      {"type": "feat", "section": "üöÄ Features"},
                      {"type": "fix", "section": "üêõ Bug Fixes"},
                      {"type": "perf", "section": "‚ö° Performance"},
                      {"type": "revert", "section": "‚è™ Reverts"},
                      {"type": "docs", "section": "üìö Documentation"},
                      {"type": "refactor", "section": "‚ôªÔ∏è Refactoring"},
                      {"type": "test", "section": "‚úÖ Tests", "hidden": true},
                      {"type": "build", "section": "üîß Build", "hidden": true},
                      {"type": "ci", "section": "üë∑ CI/CD", "hidden": true}
                    ]
                  }
                }
              ],
              [
                "@semantic-release/changelog",
                {
                  "changelogFile": "CHANGELOG.md"
                }
              ],
              [
                "@semantic-release/git",
                {
                  "assets": ["CHANGELOG.md"],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }
              ],
              "@semantic-release/github"
            ]
          }
          EOF

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Summary
        if: success()
        run: |
          echo "## üéâ Semantic Release Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Git tag created (if version bumped)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub release published (if version bumped)" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [Releases](https://github.com/${{ github.repository }}/releases) for the new version." >> $GITHUB_STEP_SUMMARY
