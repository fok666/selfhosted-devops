# Azure DevOps Agent Configuration Example
# Copy this file to terraform.tfvars and fill in your values

# Project Configuration
project_name = "my-azdevops-agent"
aws_region   = "us-east-1"  # or "us-west-2", "eu-west-1", etc.

# Azure DevOps Configuration
azp_url   = "https://dev.azure.com/your-organization"  # Your Azure DevOps organization URL
azp_token = "your-personal-access-token-here"          # PAT with Agent Pools (read, manage) scope
azp_pool  = "Default"                                   # Agent pool name

# Optional: Custom agent name prefix
azp_agent_name_prefix = "aws-agent"

# Networking (Optional - defaults provided)
# vpc_cidr = "10.0.0.0/16"

# EC2 Configuration
# ============================================================================
# ARM64 (Graviton) instances offer up to 40% cost savings vs x86-64
# See DOCKER_IMAGES.md for architecture-specific considerations
#
# x86-64 (Intel/AMD):
#   t3.medium  - 2 vCPU, 4GB RAM  ~$30/month spot
#   t3.large   - 2 vCPU, 8GB RAM  ~$60/month spot
#   c5.large   - 2 vCPU, 4GB RAM  ~$40/month spot (CPU-optimized)
#
# ARM64 (Graviton2/3):
#   t4g.medium - 2 vCPU, 4GB RAM  ~$18/month spot (40% savings!)
#   t4g.large  - 2 vCPU, 8GB RAM  ~$36/month spot (40% savings!)
#   c7g.large  - 2 vCPU, 4GB RAM  ~$24/month spot (CPU-optimized)
#
# All Docker images support both architectures automatically
# ============================================================================
instance_types     = ["t3.medium", "t3a.medium", "t2.medium"]  # Diversify for spot availability
use_spot_instances = true  # Use Spot instances for ~70% cost savings
spot_max_price     = ""    # Empty = pay up to on-demand price
spot_instance_pools = 3    # Number of instance types to use

# Docker Image Configuration
# ============================================================================
# See DOCKER_IMAGES.md for complete image variant documentation and cost analysis
#
# Available variants:
#   latest  - Full toolchain (Docker, Node.js, Python, .NET, Go, Rust, Cloud tools) ~2.8GB
#   minimal - Docker + Git only (cost-optimized) ~500MB
#   dotnet  - Docker + .NET 8.0 SDK ~1.5GB
#   node    - Docker + Node.js + npm/yarn ~1.2GB
#   python  - Docker + Python 3.11 + pip/poetry ~1.1GB
#   golang  - Docker + Go 1.21 ~1.3GB
#   cloud   - Docker + AWS CLI + Azure CLI + kubectl ~1.8GB
#
# Multi-architecture support: Both x86-64 and ARM64 automatically detected
# Cost impact: Smaller images = faster startup + lower storage costs
#
# Examples:
#   "fok666/azure-devops-agent:latest"  - Production workloads (full tools)
#   "fok666/azure-devops-agent:minimal" - Cost-optimized (simple builds)
#   "fok666/azure-devops-agent:dotnet"  - .NET projects
#   "fok666/azure-devops-agent:cloud"   - Kubernetes/IaC deployments
#   "fok666/azure-devops-agent:1.2.3"   - Pin to specific version (production)
# ============================================================================
# docker_image = "fok666/azure-devops-agent:latest"

# Autoscaling Configuration
enable_autoscaling      = true
min_instances           = 0   # Scale to zero when idle
max_instances           = 10  # Maximum number of agents
default_instances       = 1   # Starting number of agents
target_cpu_utilization  = 70  # Target CPU% for autoscaling

# Tags (Optional)
tags = {
  Environment = "production"
  Team        = "devops"
  CostCenter  = "engineering"
  ManagedBy   = "terraform"
}

# =============================================================================
# PRODUCTION FEATURES (Optional - All Disabled by Default)
# =============================================================================

# ---------- Distributed Caching (S3) ----------
# Enable distributed cache sharing across agents for faster builds
# Cost: ~$2-5/month for 100GB storage + requests
# enable_distributed_cache = true
# cache_s3_bucket_name     = "mycompany-azdevops-cache"  # Must be globally unique
# cache_s3_region          = "us-east-1"                  # Same as aws_region recommended
# cache_s3_prefix          = "cache/"
# cache_shared             = true                         # true = shared across agents, false = per-agent cache

# ---------- Centralized Logging (CloudWatch) ----------
# Send agent logs to CloudWatch for centralized log management
# Cost: ~$2-10/month (first 5GB free, then $0.50/GB ingestion + $0.03/GB storage)
# enable_centralized_logging   = true
# cloudwatch_log_group_name    = "/aws/azdevops/agents"
# cloudwatch_log_retention_days = 7

# ---------- Agent Monitoring (Prometheus Metrics) ----------
# Expose Prometheus metrics endpoint for monitoring
# Cost: Free (requires external Prometheus server)
# enable_agent_monitoring = true
# metrics_port            = 9090

# =============================================================================

# ============================================
# COST ESTIMATES (with Spot instances)
# ============================================
# Region: us-east-1
# Instance Type: t3.medium
#
# Spot Instance (~70% discount):
# - 1 instance (always-on): ~$8-10/month
# - Scale 0-5 (10% utilization): ~$3-5/month
# - Scale 0-10 (30% utilization): ~$20-30/month
#
# Production Features (Optional):
# - Distributed Cache (S3): +$2-5/month
# - Centralized Logging (CloudWatch): +$2-10/month (5GB free tier)
# - Monitoring (Prometheus): Free (requires external server)
#
# Total with all features:
# - Minimal usage: ~$7-15/month
# - Medium usage: ~$30-45/month
#
# On-Demand (for comparison):
# - 1 instance (always-on): ~$30/month
# ============================================

# ============================================
# HOW TO GET AZURE DEVOPS PAT
# ============================================
# 1. Go to https://dev.azure.com/your-organization
# 2. Click on User Settings (top right) â†’ Personal Access Tokens
# 3. Click "New Token"
# 4. Name: "Terraform Agent Token"
# 5. Organization: Select your organization
# 6. Scopes: Select "Agent Pools (Read & manage)"
# 7. Click "Create"
# 8. Copy the token immediately (you won't see it again)
# ============================================

# ============================================
# DEPLOYMENT INSTRUCTIONS
# ============================================
# 1. Copy this file: cp terraform.tfvars.example terraform.tfvars
# 2. Edit terraform.tfvars with your values
# 3. Initialize: terraform init
# 4. Plan: terraform plan
# 5. Apply: terraform apply
# 6. Check agents: https://dev.azure.com/your-org/_settings/agentpools
# ============================================

# ============================================
# INSTANCE TYPE OPTIONS
# ============================================
# Budget:
# - t3.small   (2 vCPU, 2 GB)  - Minimum recommended
# - t3.medium  (2 vCPU, 4 GB)  - Good balance
#
# Balanced:
# - t3.large   (2 vCPU, 8 GB)  - Recommended for most workloads
# - t3.xlarge  (4 vCPU, 16 GB) - Heavy workloads
#
# Compute Optimized:
# - c5.large   (2 vCPU, 4 GB)  - Compute intensive
# - c5.xlarge  (4 vCPU, 8 GB)  - Maximum compute
#
# Memory Optimized:
# - r5.large   (2 vCPU, 16 GB) - Memory intensive
# - r5.xlarge  (4 vCPU, 32 GB) - Large memory workloads
# ============================================

# ============================================
# SPOT INSTANCE BEST PRACTICES
# ============================================
# 1. Use multiple instance types for better availability
# 2. Set spot_instance_pools to 2-3 for diversification
# 3. Leave spot_max_price empty to pay on-demand price
# 4. Monitor interruption rate in CloudWatch
# 5. Scale to zero when not in use
# ============================================
